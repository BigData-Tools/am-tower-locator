<!DOCTYPE html>
<html>
  <head>
    <title>AM Tower Locator</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <script src="js/mustache.js"></script>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.css' rel='stylesheet' />
    <!--[if lte IE 8]>
      <link href='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.ie.css' rel='stylesheet' >
    <![endif]-->
    <script src='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.js'></script>
    <link href="css/am-tower-locator.css" rel="stylesheet" media="screen">
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
      <style>.station { width: 46%; }</style>
    <![endif]-->
  </head>
  <body>
    <div class="intro">
      <div class="intro-inner">
        <div class="intro-body">
          <div class="warning">
            <p>Alpha - Not Official</p>
          </div>
          <img src="img/fcc-logo.png" id="fcc-logo" title="FCC" height="28" width="34" />
          <h1>AM Tower Locator</h1>
          <h4>Enter the latitude and longitude, <strong>in decimal degrees</strong>, and height, <strong>in meters</strong>, of your tower to determine if you need to notify any AM Stations prior to building.</h4>
        </div>
        <form class="form-inline" id="locator">
          <fieldset>
            <div class="control-group">
                <label>Latitude</label>
                <input class="input-small required latitude" id="lat" name="lat" tabindex="1" type="text" placeholder="Latitude">
                <div class="help"></div>
            </div>
            <div class="control-group">
              <label>Longitude</label>
              <input class="input-small required longitude" id="long" name="long" tabindex="2" type="text" placeholder="Longitude">
              <div class="help"></div>
            </div>
            <div class="control-group">
              <label>Tower Height</label>
              <input class="input-small required num" id="height" name="height" tabindex="3" type="text" placeholder="Height">
              <div class="help"></div>
            </div>
            <br /><button id="search" name="search" type="button" class="btn" tabindex="4" value="Search">Search</button> <button class="btn btn-reset" tabindex="5" type="reset" value="Reset">Reset</button>
          </fieldset>
        </form>
        <p class="muted">
          Need help converting to decimal degrees?<br />
          <a href="http://transition.fcc.gov/mb/audio/bickel/DDDMMSS-decimal.html" target="_blank" title="Lat/Long Converter">Lat/Long Converter</a>
        </p>
      </div>
    </div>

    <div class="content">
      <div class="content-inner">
        <div id="map"></div>
        <div class="stations clearfix" id="station-notify"></div>
        <div class="stations clearfix" id="station-dont-notify"></div>
      </div>
    </div>

    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/validate.js"></script>

    <script type="text/javascript">
      $(document).ready(function() {
        // create the bg map
        var bgmap = L.mapbox.map('map', 'fcc.map-fd8wksyc', {zoomControl: false}).setView([39.833333, -98.583333], 4);
        bgmap.dragging.disable();
        bgmap.touchZoom.disable();
        bgmap.doubleClickZoom.disable();
        bgmap.scrollWheelZoom.disable();

        // form submission
        $("#locator").submit(function() {
          $("#map").css("display", "none");
          $('#station-notify, #station-dont-notify').html("");
          $('html,body').animate({
            scrollTop: $(".content").offset().top
            },
            'slow');

          // loading screen
          $.get('templates/stations.html', function(templates) {
            var template = $(templates).filter('#stations-loading').html();
            var html = Mustache.to_html(template);
            $('#station-notify').html(html);
          });

          // set up icons
          var towerIcon = L.icon({
            className: 'tower-marker',
            iconUrl: 'img/marker-tower-2x.png',
            iconSize: [25, 25]
          });
          var notifyIcon = L.icon({
            iconUrl: 'img/marker-notify-2x.png',
            iconSize: [25, 25]
          });
          var okIcon = L.icon({
            iconUrl: 'img/marker-ok-2x.png',
            iconSize: [25, 25]
          });

          var dist = 3; // meters
          
          // api url
          var stationsURL = "http://transition.fcc.gov/fcc-bin/amq?list=8&nad=83&alat=" + $("#lat").val() + "&alon=" + $("#long").val() + "&dist=" + dist;

          // call to get stations
          $.ajax({
            url: stationsURL,
            dataType: 'jsonp',
            jsonpCallback: 'callback',
            jsonp: 'callback',
            success: stations_table,
            error: function(xhr, status, error) {
              $.get('templates/stations.html', function(templates) {
                var template = $(templates).filter('#stations-api-error').html();
                var html = Mustache.to_html(template);
                $("#station-notify").html(html).fadeIn(1000);
              });
            }
          });

          // callback function
          function stations_table(stations) {
            // removes loading screen after we get results
            $('#station-notify, #station-dont-notify').html("");

            var curStationIcon;  // to switch the station icon
            
            if (stations.stations[0].ant_mode === undefined) {  // no results
              $.get('templates/stations.html', function(templates) {
                var template = $(templates).filter('#stations-none').html();
                var html = Mustache.to_html(template);
                $(html).hide().appendTo("#station-notify").fadeIn(1000);
              });
            } else {  // yes results
              // loop through api results
              $.each(stations.stations, function(key, curStation) {
                // show results one at a time
                //setTimeout(function() {
                  // create new station, used to do conversions and math
                  var modStation = new station(curStation, $("#height").val());

                  // if the station is critical
                  if (modStation.notify()) {
                    curStation.notify = "notify";
                    curStationIcon = notifyIcon;

                    // APpend modified result
                    $.get('templates/stations.html', function(templates) {
                      var template = $(templates).filter('#station-detail').html();
                      var html = Mustache.to_html(template, curStation);
                      $(html).appendTo("#station-notify");
                    });
                    
                    // interval required to make sure the map container exists
                    var checkExist = setInterval(function() {
                       if ($('#st'+curStation.facid+'-'+curStation.hours_operation+'-map').length) {
                          // set up map for a station
                          var stationMap = L.mapbox.map('st'+curStation.facid+'-'+curStation.hours_operation+'-map', 'fcc.map-fd8wksyc', {zoomControl: false}).setView([curStation.decimal_lat_nad83, curStation.decimal_lon_nad83], 12);

                          // add proposed tower marker
                          L.marker([$("#lat").val(), $("#long").val()], {
                            icon: towerIcon
                          }).bindPopup("<strong>YOUR TOWER.<strong>").addTo(stationMap);

                          // add AM tower marker
                          L.marker([curStation.decimal_lat_nad83, curStation.decimal_lon_nad83], {
                            icon: notifyIcon,
                            title: "st" + curStation.facid,
                            bounceOnAdd: true,
                            bounceOnAddOptions: {
                              duration: 1000,
                              height: 50
                            }
                          }).bindPopup("<strong>"+curStation.call+"</strong>").addTo(stationMap);

                          stationMap.dragging.disable();
                          stationMap.touchZoom.disable();
                          stationMap.doubleClickZoom.disable();
                          stationMap.scrollWheelZoom.disable();

                          // clear interval
                          clearInterval(checkExist);
                       }
                    }, 100); // check every 100ms
                  } else { // no worries
                    curStation.notify = "dont-notify";
                    curStationIcon = okIcon;

                    // APpend modified result
                    $.get('templates/stations.html', function(templates) {
                      var template = $(templates).filter('#station-detail').html();
                      var html = Mustache.to_html(template, curStation);
                      $(html).appendTo("#station-dont-notify");
                    });

                    // interval required to make sure the map container exists
                    var checkExist = setInterval(function() {
                       if ($('#st'+curStation.facid+'-'+curStation.hours_operation+'-map').length) {
                          // set up map for a station
                          var stationMap = L.mapbox.map('st'+curStation.facid+'-'+curStation.hours_operation+'-map', 'fcc.map-fd8wksyc', {zoomControl: false}).setView([curStation.decimal_lat_nad83, curStation.decimal_lon_nad83], 12);

                          // add proposed tower marker
                          L.marker([$("#lat").val(), $("#long").val()], {
                            icon: towerIcon
                          }).bindPopup("<strong>YOUR TOWER.<strong>").addTo(stationMap);

                          // add AM tower marker
                          L.marker([curStation.decimal_lat_nad83, curStation.decimal_lon_nad83], {
                            icon: okIcon,
                            title: "st" + curStation.facid,
                            bounceOnAdd: true,
                            bounceOnAddOptions: {
                              duration: 1000,
                              height: 50
                            }
                          }).bindPopup("<strong>"+curStation.call+"</strong>").addTo(stationMap);

                          stationMap.dragging.disable();
                          stationMap.touchZoom.disable();
                          stationMap.doubleClickZoom.disable();
                          stationMap.scrollWheelZoom.disable();

                          // clear interval
                          clearInterval(checkExist);
                       }
                    }, 100); // check every 100ms
                  }
                }); // end each

              // add headings
              $.get('templates/stations.html', function(templates) {
                var template = $(templates).filter('#stations-notify-heading').html();
                var html = Mustache.to_html(template);
                $(html).prependTo("#station-notify");
              });

              $.get('templates/stations.html', function(templates) {
                var template = $(templates).filter('#stations-dont-notify-heading').html();
                var html = Mustache.to_html(template);
                $(html).prependTo("#station-dont-notify");
              });

              $('html,body').animate({
                scrollTop: $(".content").offset().top
                },
                'slow');
            }
          }

          // a station
          var station = function(curStation, height) {
            // is tower directional
            var isNonDirectional = function() {
              if (curStation.ant_mode.substring(0, 3) === "NDD") {
                return true;
              }
            };

            // convert kHz to MHz
            var getMHZ = function() {
              return parseFloat(curStation.frequency.replace(" kHz", "") * .001);
            };

            // convert km to meters
            var getMeters = function() {
              return parseFloat(curStation.distance.replace(" km", "") * 1000);
            };

            // get the wavelength
            var getWavelength = function() {
              return parseFloat(300 / parseFloat(getMHZ()));
            };

            // get electrical degrees
            var getEDegrees = function(height) {
              return parseFloat(parseFloat(height) / parseFloat(getWavelength()) * 360);
            };

            // should this tower be notified
            var isCritical = function() {
              if (isNonDirectional()) {
                if ((getWavelength() < getMeters()) && getEDegrees(height) > 60) {
                  return true;
                }
              } else {  // its directional
                if (getMeters() < getWavelength() * 10 && getMeters() < 3000 && getEDegrees(height) > 36) {
                  return true;
                }
              }
            };

            // public
            return {
              notify: isCritical
            };
          }
          return false;
        });
      });
    </script>
  </body>
</html>
